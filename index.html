<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Manajemen Perpustakaan (SIMPUS) Pro</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            @page { margin: 0.5cm; size: A4; }
            .no-print { display: none !important; }
            .print-container { display: block !important; }
            body { background: white; -webkit-print-color-adjust: exact; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
        .print-container { display: none; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#64748b',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. ICON SET ---
        const Icons = {
            Book: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Repeat: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
            BarChart3: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.52a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Save: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            LayoutGrid: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
            Camera: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>,
            Box: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/><line x1="3.27" y1="16.96" x2="12" y2="12.01"/><line x1="20.73" y1="16.96" x2="12" y2="12.01"/></svg>,
            Archive: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
        };

        // --- 2. HELPERS ---
        const { useState, useEffect, useMemo } = React;
        const STORAGE_KEY = 'simpus_pro_v4'; // Versi baru

        const downloadCSV = (content, fileName) => {
            const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        const jsonToCSV = (items) => {
            if (!items || items.length === 0) return '';
            const header = Object.keys(items[0]);
            const csv = [
                header.join(','), 
                ...items.map(row => header.map(fieldName => JSON.stringify(row[fieldName], (key, value) => value === null ? '' : value)).join(','))
            ].join('\r\n');
            return csv;
        };

        const csvToJSON = (csvText) => {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            const result = [];
            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentline = lines[i].split(',').map(field => field.trim().replace(/^"|"$/g, ''));
                if(currentline.length !== headers.length) continue;
                headers.forEach((h, j) => obj[h] = currentline[j]);
                result.push(obj);
            }
            return result;
        };

        // --- 3. COMPONENTS ---

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-sm p-4 print:hidden transition-all">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto animate-fade-in border border-slate-100">
                        <div className="flex justify-between items-center p-5 border-b border-slate-100">
                            <h3 className="text-xl font-bold text-slate-800 tracking-tight">{title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-slate-50">
                                <Icons.X size={22} />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        const BarcodeScanner = ({ onScan, onClose }) => {
            useEffect(() => {
                let scanner;
                try {
                    scanner = new Html5QrcodeScanner("reader", { 
                        fps: 10, 
                        qrbox: { width: 250, height: 250 },
                        aspectRatio: 1.0 
                    });
                    
                    scanner.render((decodedText) => {
                        scanner.clear();
                        onScan(decodedText);
                    }, (errorMessage) => { });
                } catch (e) {
                    console.error("Scanner Error", e);
                }

                return () => { try { if(scanner) scanner.clear(); } catch(e) {} };
            }, [onScan]);

            return (
                <div className="fixed inset-0 z-[60] bg-black bg-opacity-90 flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-xl w-full max-w-md p-4 space-y-4">
                        <div className="flex justify-between items-center">
                            <h3 className="font-bold text-lg">Scan Barcode/QR</h3>
                            <button onClick={onClose} className="bg-gray-200 p-2 rounded-full hover:bg-gray-300"><Icons.X size={20}/></button>
                        </div>
                        <div id="reader" className="w-full h-64 bg-gray-100 rounded-lg"></div>
                        <p className="text-sm text-center text-red-500 font-medium">
                            Jika kamera tidak muncul, pastikan Anda membuka aplikasi ini via HTTPS atau localhost. Browser memblokir kamera pada file://.
                        </p>
                    </div>
                </div>
            );
        };

        const SimpleBarChart = ({ data }) => {
            const maxValue = Math.max(...data.map(d => d.value), 1);
            return (
                <div className="w-full h-full flex items-end justify-between gap-2 pt-4 px-2">
                    {data.map((item, index) => {
                        const heightPercent = (item.value / maxValue) * 100;
                        const colors = ['bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-rose-500'];
                        return (
                            <div key={index} className="flex flex-col items-center flex-1 h-full justify-end group">
                                <div className="relative w-full flex justify-center items-end h-[85%]">
                                    <div 
                                        className={`w-full max-w-[40px] rounded-t-md transition-all duration-500 ${colors[index % 4]} hover:opacity-80`}
                                        style={{ height: `${heightPercent}%` }}
                                    >
                                        <span className="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">
                                            {item.value}
                                        </span>
                                    </div>
                                </div>
                                <div className="mt-2 text-xs text-gray-500 font-medium truncate w-full text-center h-[15%]">
                                    {item.name}
                                </div>
                            </div>
                        )
                    })}
                </div>
            );
        };

        const PrintView = ({ type, items, settings, extraData, onCancel }) => {
            const QR_API_BASE = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=";
            
            return (
                <div className="fixed inset-0 z-[60] bg-gray-100 overflow-auto flex flex-col">
                    <div className="bg-slate-800 text-white p-4 shadow-md flex justify-between items-center no-print sticky top-0 z-50">
                        <div>
                            <h2 className="text-xl font-bold">Pratinjau Cetak: {type === 'history' ? 'Laporan Riwayat' : type === 'card' ? 'Kartu Anggota' : 'Label Buku'}</h2>
                            <p className="text-sm opacity-80">Tekan Ctrl+P untuk mencetak.</p>
                        </div>
                        <div className="space-x-2">
                            <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded flex items-center gap-2 inline-flex border border-white/20">
                                <Icons.Printer size={18} /> Cetak
                            </button>
                            <button onClick={onCancel} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded border border-white/20">Tutup</button>
                        </div>
                    </div>

                    <div className="print-container p-8 mx-auto bg-white min-h-screen w-full max-w-[210mm]">
                        {type === 'history' && (
                            <>
                                <div className="mb-6 border-b-2 border-black pb-4 text-center">
                                    <h1 className="text-2xl font-bold uppercase tracking-wide">{settings.libraryName}</h1>
                                    <p className="text-sm text-gray-600">{settings.address}</p>
                                    <h2 className="text-xl font-bold mt-4 underline decoration-2 decoration-slate-400">LAPORAN RIWAYAT PEMINJAMAN</h2>
                                </div>
                                <div className="mb-6 bg-slate-50 p-4 rounded border border-slate-200">
                                    <table className="w-full text-sm">
                                        <tbody>
                                            <tr><td className="font-bold w-32 py-1">Nama Anggota</td><td>: {items.name}</td></tr>
                                            <tr><td className="font-bold py-1">ID / NIS</td><td>: {items.id} / {items.nis}</td></tr>
                                            <tr><td className="font-bold py-1">Kelas</td><td>: {items.class}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <table className="w-full border-collapse border border-slate-300 text-sm shadow-sm">
                                    <thead className="bg-slate-100">
                                        <tr>
                                            <th className="border border-slate-300 p-2">No</th>
                                            <th className="border border-slate-300 p-2">Judul Buku</th>
                                            <th className="border border-slate-300 p-2">Tgl Pinjam</th>
                                            <th className="border border-slate-300 p-2">Tgl Kembali</th>
                                            <th className="border border-slate-300 p-2">Status</th>
                                            <th className="border border-slate-300 p-2 text-right">Denda</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {extraData.transactions.map((t, idx) => {
                                            const book = extraData.books.find(b => b.id === t.bookId);
                                            return (
                                                <tr key={t.id} className="even:bg-slate-50">
                                                    <td className="border border-slate-300 p-2 text-center">{idx + 1}</td>
                                                    <td className="border border-slate-300 p-2 font-medium">{book?.title}</td>
                                                    <td className="border border-slate-300 p-2 text-center">{new Date(t.borrowDate).toLocaleDateString('id-ID')}</td>
                                                    <td className="border border-slate-300 p-2 text-center">{t.returnDate ? new Date(t.returnDate).toLocaleDateString('id-ID') : '-'}</td>
                                                    <td className="border border-slate-300 p-2 text-center">{t.status === 'returned' ? 'Kembali' : 'Dipinjam'}</td>
                                                    <td className="border border-slate-300 p-2 text-right">{t.fine > 0 ? t.fine.toLocaleString() : '-'}</td>
                                                </tr>
                                            )
                                        })}
                                    </tbody>
                                </table>
                                <div className="mt-12 flex justify-end">
                                    <div className="text-center w-48">
                                        <p className="text-sm">Dicetak pada: {new Date().toLocaleDateString('id-ID')}</p>
                                        <div className="h-20 border-b border-black mb-2"></div>
                                        <p className="font-bold">( Petugas Perpustakaan )</p>
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {type === 'card' && (
                            <div className="grid grid-cols-2 gap-4">
                                {items.map((member) => (
                                    <div key={member.id} className="border-2 border-slate-800 rounded-xl p-4 flex gap-4 h-[55mm] overflow-hidden relative break-inside-avoid bg-white shadow-sm print:shadow-none">
                                        <div className="w-24 h-32 bg-slate-100 flex-shrink-0 border flex items-center justify-center rounded">
                                            <Icons.Users size={40} className="text-slate-300" />
                                        </div>
                                        <div className="flex-1 flex flex-col justify-between">
                                            <div>
                                                <h3 className="font-bold text-lg text-slate-800 uppercase border-b-2 border-slate-800 mb-1 leading-tight">{settings.libraryName}</h3>
                                                <p className="font-bold text-xl mt-1 text-indigo-900">{member.name}</p>
                                                <p className="text-sm font-mono text-slate-600">{member.id}</p>
                                                <p className="text-sm text-slate-600">{member.class}</p>
                                            </div>
                                            <div className="absolute bottom-2 right-2">
                                                <img src={`${QR_API_BASE}${member.id}`} alt="QR" className="w-16 h-16 mix-blend-multiply" />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {type === 'label' && (
                            <div className="grid grid-cols-3 gap-2">
                                {items.map((book) => (
                                    <div key={book.id} className="border border-slate-400 p-2 h-[40mm] flex gap-2 break-inside-avoid relative rounded bg-white">
                                        <div className="flex-1 overflow-hidden">
                                            <p className="text-[9px] uppercase font-bold text-center border-b border-black mb-1 truncate">{settings.libraryName}</p>
                                            <p className="font-mono font-bold text-lg text-center leading-none mt-1">{book.location}</p>
                                            <p className="font-bold text-xs text-center leading-tight mt-1 line-clamp-2">{book.title.substring(0,25)}</p>
                                            <p className="text-[10px] text-center text-slate-500 mt-1">{book.author.substring(0,15)}</p>
                                        </div>
                                        <div className="w-14 flex-shrink-0 flex items-center justify-center">
                                            <img src={`${QR_API_BASE}${book.id}`} alt="QR" className="w-full" />
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const InventoryCheck = ({ books, onClose }) => {
            const [scanned, setScanned] = useState({});
            const [scanMode, setScanMode] = useState(false);

            const handleScan = (code) => {
                setScanMode(false);
                const book = books.find(b => b.id === code);
                if (!book) return alert("Buku tidak ditemukan di sistem!");
                setScanned(prev => ({ ...prev, [code]: (prev[code] || 0) + 1 }));
            };

            const downloadReport = () => {
                const report = books.map(b => ({
                    ID: b.id,
                    Judul: b.title,
                    StokSistem: b.stock,
                    StokFisik: scanned[b.id] || 0,
                    Selisih: (scanned[b.id] || 0) - b.stock,
                    Status: (scanned[b.id] || 0) === parseInt(b.stock) ? 'Cocok' : 'Selisih'
                }));
                downloadCSV(jsonToCSV(report), 'Laporan_Stock_Opname.csv');
            };

            return (
                <div className="space-y-4">
                    {scanMode && <BarcodeScanner onScan={handleScan} onClose={() => setScanMode(false)} />}
                    <div className="flex justify-between items-center bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                         <div>
                            <h4 className="font-bold text-indigo-900">Mode Stock Opname</h4>
                            <p className="text-sm text-indigo-700">Scan fisik buku untuk mencocokkan stok.</p>
                         </div>
                         <div className="flex gap-2">
                             <button onClick={() => setScanMode(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 shadow-sm"><Icons.Camera size={18}/> Scan Buku</button>
                             <button onClick={downloadReport} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-700 shadow-sm"><Icons.Download size={18}/> Export Hasil</button>
                         </div>
                    </div>
                    <div className="overflow-auto max-h-[60vh] border rounded-lg">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 sticky top-0 text-slate-600">
                                <tr>
                                    <th className="p-3">Buku</th>
                                    <th className="p-3 text-center">Stok Sistem</th>
                                    <th className="p-3 text-center">Stok Fisik</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {books.map(b => {
                                    const physical = scanned[b.id] || 0;
                                    const match = physical === parseInt(b.stock);
                                    return (
                                        <tr key={b.id} className={!match && physical > 0 ? "bg-red-50" : ""}>
                                            <td className="p-3 font-medium">{b.title} <div className="text-xs text-slate-400 font-mono">{b.id}</div></td>
                                            <td className="p-3 text-center">{b.stock}</td>
                                            <td className="p-3 text-center font-bold">{physical}</td>
                                            <td className="p-3 text-center">
                                                {physical === 0 ? <span className="text-slate-400">-</span> : 
                                                 match ? <span className="text-emerald-600 font-bold">Cocok</span> : 
                                                 <span className="text-red-600 font-bold">Selisih</span>}
                                            </td>
                                            <td className="p-3 text-right">
                                                <button onClick={() => setScanned(p => ({...p, [b.id]: (p[b.id] || 0) + 1}))} className="text-xs bg-slate-200 hover:bg-slate-300 px-2 py-1 rounded">+1 Manual</button>
                                            </td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            )
        };

        const MemberHistory = ({ member, transactions, books, onPrint }) => {
            const history = transactions.filter(t => t.memberId === member.id).sort((a,b) => new Date(b.borrowDate) - new Date(a.borrowDate));
            
            return (
                <div className="space-y-4">
                     <div className="flex justify-between items-start bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                        <div>
                            <h3 className="font-bold text-lg text-indigo-900">{member.name}</h3>
                            <p className="text-sm text-indigo-700">ID: {member.id} | {member.class}</p>
                        </div>
                        <button onClick={() => onPrint(member)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-indigo-700 shadow-sm transition-transform hover:-translate-y-0.5">
                            <Icons.Printer size={16} /> Cetak Laporan
                        </button>
                     </div>
                     
                     <div className="overflow-auto max-h-[300px] border rounded-lg border-slate-200">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 sticky top-0 text-slate-600">
                                <tr>
                                    <th className="p-3 border-b">Buku</th>
                                    <th className="p-3 border-b">Pinjam</th>
                                    <th className="p-3 border-b">Kembali</th>
                                    <th className="p-3 border-b text-center">Status</th>
                                    <th className="p-3 border-b text-right">Denda</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {history.map(t => {
                                    const book = books.find(b => b.id === t.bookId);
                                    return (
                                        <tr key={t.id} className="hover:bg-slate-50">
                                            <td className="p-3 font-medium">{book?.title || 'Unknown'}</td>
                                            <td className="p-3">{new Date(t.borrowDate).toLocaleDateString('id-ID')}</td>
                                            <td className="p-3">{t.returnDate ? new Date(t.returnDate).toLocaleDateString('id-ID') : '-'}</td>
                                            <td className="p-3 text-center">
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${t.status === 'returned' ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-700'}`}>
                                                    {t.status === 'returned' ? 'Kembali' : 'Dipinjam'}
                                                </span>
                                            </td>
                                            <td className="p-3 text-right font-mono text-slate-600">{t.fine > 0 ? `Rp ${t.fine}` : '-'}</td>
                                        </tr>
                                    )
                                })}
                                {history.length === 0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">Belum ada riwayat peminjaman</td></tr>}
                            </tbody>
                        </table>
                     </div>
                </div>
            )
        };

        const BorrowForm = ({ members, books, settings, onSubmit }) => {
            const [selMember, setSelMember] = useState("");
            const [selBook, setSelBook] = useState("");
            const [showScanner, setShowScanner] = useState(false);
            const [scanTarget, setScanTarget] = useState(null); 

            const activeMember = members.find(m => m.id === selMember);
            const activeBook = books.find(b => b.id === selBook);
            const isStockZero = activeBook && parseInt(activeBook.stock) <= 0;
            const dueDate = new Date(Date.now() + (settings.loanDuration * 24 * 60 * 60 * 1000));

            const handleScan = (code) => {
                setShowScanner(false);
                if (scanTarget === 'member') {
                    const m = members.find(x => x.id === code);
                    if(m) setSelMember(m.id); else alert("Anggota tidak ditemukan");
                } else {
                    const b = books.find(x => x.id === code);
                    if(b) setSelBook(b.id); else alert("Buku tidak ditemukan");
                }
            };

            const submitTx = (e) => {
                e.preventDefault();
                if(!selMember || !selBook) return;
                onSubmit({ memberId: selMember, bookId: selBook, isReservation: isStockZero });
            };

            return (
                <div className="space-y-4">
                    {showScanner && <BarcodeScanner onScan={handleScan} onClose={() => setShowScanner(false)} />}
                    
                    {/* Datalists for Autocomplete */}
                    <datalist id="memberList">
                        {members.map(m => <option key={m.id} value={m.id}>{m.name} - {m.class}</option>)}
                    </datalist>
                    <datalist id="bookList">
                        {books.map(b => <option key={b.id} value={b.id}>{b.title} (Stok: {b.stock})</option>)}
                    </datalist>

                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">ID Anggota</label>
                            <div className="flex gap-2">
                                <input 
                                    list="memberList"
                                    value={selMember} 
                                    onChange={e => setSelMember(e.target.value)} 
                                    placeholder="Ketik ID / Nama atau Scan..." 
                                    className="flex-1 border p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" 
                                />
                                <button onClick={() => { setScanTarget('member'); setShowScanner(true); }} className="bg-indigo-100 text-indigo-700 p-2 rounded-lg hover:bg-indigo-200 transition-colors"><Icons.Camera size={20}/></button>
                            </div>
                            {activeMember ? (
                                <div className="mt-2 text-sm text-indigo-800 bg-indigo-50 p-2 rounded border border-indigo-100 flex items-center gap-2">
                                    <Icons.Users size={16}/>
                                    <div>
                                        <p className="font-bold">{activeMember.name}</p>
                                        <p className="text-xs">{activeMember.class} | {activeMember.phone}</p>
                                    </div>
                                </div>
                            ) : selMember && <p className="text-xs text-red-500 mt-1">Anggota tidak ditemukan</p>}
                        </div>

                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">ID Buku</label>
                            <div className="flex gap-2">
                                <input 
                                    list="bookList"
                                    value={selBook} 
                                    onChange={e => setSelBook(e.target.value)} 
                                    placeholder="Ketik ID / Judul atau Scan..." 
                                    className="flex-1 border p-2 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" 
                                />
                                <button onClick={() => { setScanTarget('book'); setShowScanner(true); }} className="bg-indigo-100 text-indigo-700 p-2 rounded-lg hover:bg-indigo-200 transition-colors"><Icons.Camera size={20}/></button>
                            </div>
                            {activeBook ? (
                                <div className={`mt-2 text-sm p-2 rounded border flex flex-col gap-1 ${isStockZero ? 'bg-orange-50 border-orange-100 text-orange-800' : 'bg-emerald-50 border-emerald-100 text-emerald-800'}`}>
                                    <div className="flex items-center gap-2">
                                        <Icons.Book size={16}/>
                                        <p className="font-bold">{activeBook.title}</p>
                                    </div>
                                    <div className="flex justify-between text-xs mt-1">
                                        <span>Stok: <b>{activeBook.stock}</b></span>
                                        <span>Rak: <b>{activeBook.location}</b></span>
                                    </div>
                                    {isStockZero && <p className="text-xs font-bold mt-1 text-orange-600">âš  Stok Habis - Masuk antrean booking</p>}
                                </div>
                            ) : selBook && <p className="text-xs text-red-500 mt-1">Buku tidak ditemukan</p>}
                        </div>
                    </div>

                    {activeBook && activeMember && !isStockZero && (
                        <div className="flex justify-between text-xs bg-gray-100 p-3 rounded text-gray-600">
                            <span>Lama Pinjam: <b>{settings.loanDuration} Hari</b></span>
                            <span>Jatuh Tempo: <b>{dueDate.toLocaleDateString('id-ID')}</b></span>
                        </div>
                    )}

                    <button onClick={submitTx} disabled={!activeMember || !activeBook} className={`w-full py-3 rounded-lg font-bold text-white shadow-lg transition-transform hover:scale-[1.02] ${isStockZero ? 'bg-orange-500 hover:bg-orange-600' : 'bg-indigo-600 hover:bg-indigo-700'} disabled:opacity-50 disabled:cursor-not-allowed`}>
                        {isStockZero ? 'Buat Reservasi (Booking)' : 'Proses Peminjaman'}
                    </button>
                </div>
            );
        };

        // --- 4. MAIN APP ---
        const App = () => {
            const INITIAL_DATA = {
                settings: { libraryName: "Perpustakaan SMAN 1 Harapan Bangsa", finePerDay: 500, loanDuration: 7, address: "Jl. Pendidikan No. 123, Jakarta" },
                books: [
                    { id: 'B001', title: 'Laskar Pelangi', author: 'Andrea Hirata', publisher: 'Bentang', year: '2005', category: 'Fiksi', stock: 5, location: 'Rak A1', isbn: '978-979-3062-79-2' },
                    { id: 'B002', title: 'Bumi Manusia', author: 'Pramoedya Ananta Toer', publisher: 'Hasta Mitra', year: '1980', category: 'Sastra', stock: 0, location: 'Rak A2', isbn: '978-979-9731-23-4' },
                ],
                members: [
                    { id: 'M001', name: 'Budi Santoso', class: 'XII IPA 1', nis: '12345', phone: '08123456789', active: true },
                    { id: 'M002', name: 'Siti Aminah', class: 'XI IPS 2', nis: '12346', phone: '08129876543', active: true },
                ],
                transactions: [],
                reservations: [
                     { id: 'R001', bookId: 'B002', memberId: 'M002', requestDate: '2023-11-01', status: 'pending' }
                ] 
            };

            const [activeTab, setActiveTab] = useState('dashboard');
            const [data, setData] = useState(INITIAL_DATA);
            const [isLoaded, setIsLoaded] = useState(false);
            
            // UI State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalType, setModalType] = useState(null); 
            const [currentItem, setCurrentItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedItems, setSelectedItems] = useState([]);
            const [printMode, setPrintMode] = useState(null);
            const [printData, setPrintData] = useState(null);

            useEffect(() => {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) setData(JSON.parse(savedData));
                setIsLoaded(true);
            }, []);

            useEffect(() => {
                if (isLoaded) localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            }, [data, isLoaded]);

            // Handlers
            const handleAddItem = (collection, item) => {
                const idPrefix = collection === 'books' ? 'B' : 'M';
                const newItem = { ...item, id: item.id || `${idPrefix}${Date.now()}` };
                setData(prev => ({ ...prev, [collection]: [...prev[collection], newItem] }));
                setIsModalOpen(false);
            };

            const handleUpdateItem = (collection, item) => {
                setData(prev => ({ ...prev, [collection]: prev[collection].map(i => i.id === item.id ? item : i) }));
                setIsModalOpen(false);
            };

            const handleDeleteItem = (collection, id) => {
                if (window.confirm("Yakin ingin menghapus data ini?")) {
                    setData(prev => ({ ...prev, [collection]: prev[collection].filter(i => i.id !== id) }));
                }
            };

            const handleTransaction = (txData) => {
                if(txData.isReservation) {
                    const newRes = {
                        id: `R${Date.now()}`,
                        bookId: txData.bookId,
                        memberId: txData.memberId,
                        requestDate: new Date().toISOString(),
                        status: 'pending'
                    };
                    setData(prev => ({ ...prev, reservations: [...prev.reservations, newRes] }));
                    alert("Berhasil masuk antrean reservasi.");
                } else {
                    const updatedBooks = data.books.map(b => b.id === txData.bookId ? { ...b, stock: b.stock - 1 } : b);
                    const newTransaction = {
                        id: `T${Date.now()}`,
                        bookId: txData.bookId,
                        memberId: txData.memberId,
                        borrowDate: new Date().toISOString(),
                        dueDate: new Date(Date.now() + (data.settings.loanDuration * 24 * 60 * 60 * 1000)).toISOString(),
                        returnDate: null,
                        status: 'borrowed',
                        fine: 0
                    };
                    setData(prev => ({ ...prev, books: updatedBooks, transactions: [...prev.transactions, newTransaction] }));
                }
                setIsModalOpen(false);
            };

            const handleReturnBook = (transactionId) => {
                const tx = data.transactions.find(t => t.id === transactionId);
                if (!tx) return;
                
                const due = new Date(tx.dueDate); due.setHours(0,0,0,0);
                const now = new Date(); now.setHours(0,0,0,0);
                let fine = 0;
                if (now > due) {
                    const diffDays = Math.ceil((now - due) / (1000 * 60 * 60 * 24));
                    fine = diffDays * data.settings.finePerDay;
                }

                const updatedTx = data.transactions.map(t => 
                    t.id === transactionId ? { ...t, returnDate: new Date().toISOString(), status: 'returned', fine } : t
                );
                const updatedBooks = data.books.map(b => b.id === tx.bookId ? { ...b, stock: b.stock + 1 } : b);
                setData(prev => ({ ...prev, books: updatedBooks, transactions: updatedTx }));
            };

            // SETTINGS HANDLERS
            const handleRestoreJSON = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const parsed = JSON.parse(evt.target.result);
                        if (confirm("Data saat ini akan ditimpa dengan data backup. Lanjutkan?")) {
                            setData(parsed);
                            alert("Restore data berhasil!");
                        }
                    } catch (err) {
                        alert("File JSON korup atau tidak valid.");
                    }
                };
                reader.readAsText(file);
            };

            const downloadJSON = () => {
                const fileName = `backup_simpus_${new Date().toISOString().slice(0,10)}.json`;
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportCSV = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const csvData = csvToJSON(evt.target.result);
                    if(csvData.length > 0) {
                        if(confirm(`Ditemukan ${csvData.length} data. Yakin ingin import?`)) {
                            setData(prev => {
                                const currentIds = new Set(prev[type].map(i => i.id));
                                const newItems = csvData.filter(item => !currentIds.has(item.id));
                                return { ...prev, [type]: [...prev[type], ...newItems] };
                            });
                            alert("Import berhasil!");
                        }
                    }
                };
                reader.readAsText(file);
            };

            const getTemplate = (type) => {
                if(type === 'books') return "id,title,author,publisher,year,category,stock,location,isbn\nB00X,Judul,Pengarang,Penerbit,2024,Umum,5,Rak A,123-456";
                return "id,name,class,nis,phone,active\nM00X,Nama Siswa,X IPA 1,12345,081234,true";
            };

            // RENDERERS
            const renderModalContent = () => {
                if (!modalType) return null;
                
                if (modalType === 'inventory') return <InventoryCheck books={data.books} onClose={() => setIsModalOpen(false)} />;
                if (modalType === 'borrow') return <BorrowForm members={data.members} books={data.books} settings={data.settings} onSubmit={handleTransaction} />;
                if (modalType === 'memberHistory') return <MemberHistory member={currentItem} transactions={data.transactions} books={data.books} onPrint={(m) => {
                     const history = data.transactions.filter(t => t.memberId === m.id).sort((a,b) => new Date(b.borrowDate) - new Date(a.borrowDate));
                     setPrintData({ transactions: history, books: data.books });
                     setCurrentItem(m); 
                     setPrintMode('history');
                }} />;

                const isEdit = modalType.startsWith('edit');
                const isBook = modalType.includes('Book');
                
                const handleSubmit = (e) => {
                    e.preventDefault();
                    const fd = new FormData(e.target);
                    const obj = Object.fromEntries(fd.entries());
                    if (isBook) isEdit ? handleUpdateItem('books', { ...currentItem, ...obj }) : handleAddItem('books', obj);
                    else {
                        obj.active = isEdit ? currentItem.active : true;
                        isEdit ? handleUpdateItem('members', { ...currentItem, ...obj }) : handleAddItem('members', obj);
                    }
                };

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {isBook ? (
                            <>
                                <input name="title" defaultValue={currentItem?.title} placeholder="Judul Buku" required className="w-full border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <div className="grid grid-cols-2 gap-4">
                                    <input name="author" defaultValue={currentItem?.author} placeholder="Pengarang" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <input name="year" defaultValue={currentItem?.year} placeholder="Tahun" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <input name="isbn" defaultValue={currentItem?.isbn} placeholder="Nomor ISBN" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <input name="publisher" defaultValue={currentItem?.publisher} placeholder="Penerbit" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <input name="category" defaultValue={currentItem?.category} placeholder="Kategori" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <input name="location" defaultValue={currentItem?.location} placeholder="Rak" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <input name="stock" type="number" defaultValue={currentItem?.stock} placeholder="Stok" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <input name="id" defaultValue={currentItem?.id} placeholder="ID Buku (Opsional)" disabled={isEdit} className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none disabled:opacity-50" />
                                </div>
                            </>
                        ) : (
                            <>
                                <input name="name" defaultValue={currentItem?.name} placeholder="Nama Lengkap" required className="w-full border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                <div className="grid grid-cols-2 gap-4">
                                    <input name="nis" defaultValue={currentItem?.nis} placeholder="NIS / NIK" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                    <input name="class" defaultValue={currentItem?.class} placeholder="Kelas / Jabatan" className="border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                                </div>
                                <input name="phone" defaultValue={currentItem?.phone} placeholder="No HP" className="w-full border p-3 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none" />
                            </>
                        )}
                        <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 shadow-lg transition-all">Simpan Data</button>
                    </form>
                );
            };

            const DataTable = ({ type }) => {
                const isBook = type === 'books';
                const items = isBook ? data.books : data.members;
                const filtered = items.filter(i => (isBook ? i.title : i.name).toLowerCase().includes(searchTerm.toLowerCase()));
                
                return (
                    <div className="space-y-4 animate-fade-in">
                        <div className="flex flex-col md:flex-row justify-between gap-4">
                            <h2 className="text-2xl font-bold text-slate-800">{isBook ? 'Koleksi Buku' : 'Data Anggota'}</h2>
                            <div className="flex gap-2">
                                <input className="border border-slate-200 p-2 rounded-lg w-full md:w-64 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder={`Cari ${isBook ? 'Buku' : 'Anggota'}...`} value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <button onClick={() => { setCurrentItem({}); setModalType(isBook ? 'addBook' : 'addMember'); setIsModalOpen(true); }} className="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 flex items-center gap-2 shadow-sm"><Icons.Plus size={18}/> Tambah</button>
                                {selectedItems.length > 0 && <button onClick={() => setPrintMode(isBook ? 'label' : 'card')} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center gap-2 shadow-sm"><Icons.Printer size={18}/> Print</button>}
                            </div>
                        </div>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                             <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 uppercase text-xs font-semibold">
                                    <tr>
                                        <th className="p-4 w-10"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" onChange={e => setSelectedItems(e.target.checked ? filtered.map(i => i.id) : [])} checked={selectedItems.length === filtered.length && filtered.length > 0} /></th>
                                        <th className="p-4">{isBook ? 'Informasi Buku' : 'Profil Anggota'}</th>
                                        <th className="p-4 hidden md:table-cell">{isBook ? 'Lokasi' : 'ID & Kontak'}</th>
                                        <th className="p-4 text-center">{isBook ? 'Stok' : 'Status'}</th>
                                        <th className="p-4 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {filtered.map(item => (
                                        <tr key={item.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={selectedItems.includes(item.id)} onChange={() => setSelectedItems(p => p.includes(item.id) ? p.filter(x => x !== item.id) : [...p, item.id])} /></td>
                                            <td className="p-4">
                                                <div className="font-bold text-slate-800">{isBook ? item.title : item.name}</div>
                                                <div className="text-xs text-slate-500">{isBook ? `${item.author} (${item.year})` : item.class}</div>
                                                <div className="text-xs text-slate-400 font-mono mt-0.5">{item.id}</div>
                                            </td>
                                            <td className="p-4 hidden md:table-cell text-slate-600">{isBook ? item.location : <div>{item.id}<br/>{item.phone}</div>}</td>
                                            <td className="p-4 text-center">
                                                {isBook ? (
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${item.stock > 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>{item.stock}</span>
                                                ) : (
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${item.active ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'}`}>{item.active ? 'Aktif' : 'Non'}</span>
                                                )}
                                            </td>
                                            <td className="p-4 text-right space-x-1">
                                                {!isBook && <button onClick={() => { setCurrentItem(item); setModalType('memberHistory'); setIsModalOpen(true); }} className="text-indigo-600 hover:bg-indigo-50 p-1.5 rounded"><Icons.Clock size={16}/></button>}
                                                <button onClick={() => { setCurrentItem(item); setModalType(isBook ? 'editBook' : 'editMember'); setIsModalOpen(true); }} className="text-blue-600 hover:bg-blue-50 p-1.5 rounded"><Icons.Edit size={16}/></button>
                                                <button onClick={() => handleDeleteItem(type, item.id)} className="text-red-600 hover:bg-red-50 p-1.5 rounded"><Icons.Trash2 size={16}/></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                             </table>
                        </div>
                    </div>
                )
            };

            const Circulation = () => {
                const activeLoans = data.transactions.filter(t => t.status === 'borrowed');
                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex gap-4 flex-col md:flex-row">
                             <button onClick={() => { setModalType('borrow'); setIsModalOpen(true); }} className="bg-indigo-600 text-white p-6 rounded-2xl shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-4 md:w-1/3 transition-all transform hover:-translate-y-1">
                                <div className="bg-white bg-opacity-20 p-3 rounded-full"><Icons.Plus size={32} /></div>
                                <div className="text-left">
                                    <div className="font-bold text-lg">Transaksi Baru</div>
                                    <div className="text-indigo-100 text-sm">Pinjam atau Reservasi</div>
                                </div>
                            </button>
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex-1">
                                <h3 className="font-bold mb-4 flex items-center gap-2 text-slate-700"><Icons.Repeat size={20}/> Sedang Dipinjam ({activeLoans.length})</h3>
                                <div className="overflow-auto max-h-60">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 sticky top-0 text-slate-500"><tr><th className="p-3">Peminjam</th><th className="p-3">Buku</th><th className="p-3">Deadline</th><th className="p-3 text-right">Aksi</th></tr></thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {activeLoans.map(t => {
                                                const m = data.members.find(x => x.id === t.memberId);
                                                const b = data.books.find(x => x.id === t.bookId);
                                                const isLate = new Date() > new Date(t.dueDate);
                                                return (
                                                    <tr key={t.id} className={isLate ? 'bg-red-50' : ''}>
                                                        <td className="p-3"><div className="font-bold text-slate-700">{m?.name}</div><div className="text-xs text-slate-400">{m?.id}</div></td>
                                                        <td className="p-3 text-slate-600">{b?.title}</td>
                                                        <td className={`p-3 ${isLate ? 'text-red-600 font-bold' : 'text-slate-600'}`}>{new Date(t.dueDate).toLocaleDateString('id-ID')}</td>
                                                        <td className="p-3 text-right"><button onClick={() => handleReturnBook(t.id)} className="bg-emerald-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-emerald-700 shadow-sm">Kembali</button></td>
                                                    </tr>
                                                )
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const Dashboard = () => (
                <div className="space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        {[
                            { label: 'Koleksi Buku', val: data.books.length, icon: <Icons.Book className="text-white"/>, color: 'bg-gradient-to-br from-blue-500 to-blue-600' },
                            { label: 'Anggota', val: data.members.length, icon: <Icons.Users className="text-white"/>, color: 'bg-gradient-to-br from-emerald-500 to-emerald-600' },
                            { label: 'Reservasi', val: data.reservations.length, icon: <Icons.Archive className="text-white"/>, color: 'bg-gradient-to-br from-orange-500 to-orange-600' },
                            { label: 'Dipinjam', val: data.transactions.filter(t=>t.status==='borrowed').length, icon: <Icons.Repeat className="text-white"/>, color: 'bg-gradient-to-br from-purple-500 to-purple-600' }
                        ].map((stat, idx) => (
                            <div key={idx} className={`${stat.color} p-6 rounded-2xl shadow-lg text-white transform hover:scale-105 transition-transform duration-200`}>
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-blue-100 text-sm font-medium">{stat.label}</p>
                                        <h3 className="text-3xl font-bold mt-1">{stat.val}</h3>
                                    </div>
                                    <div className="p-2 bg-white bg-opacity-20 rounded-lg">{stat.icon}</div>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80">
                         <h3 className="font-bold text-slate-800 mb-4">Statistik Kategori Buku</h3>
                         <SimpleBarChart data={Object.entries(data.books.reduce((acc,b)=>(acc[b.category]=(acc[b.category]||0)+1,acc),{})).map(([k,v])=>({name:k,value:v}))} />
                    </div>
                </div>
            );

            const Inventory = () => (
                <div className="space-y-4 animate-fade-in">
                    <div className="bg-indigo-600 p-8 rounded-2xl text-white shadow-lg flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold">Stock Opname & Inventory</h2>
                            <p className="text-indigo-200 mt-1">Lakukan pengecekan stok fisik secara berkala untuk akurasi data.</p>
                        </div>
                        <button onClick={() => { setModalType('inventory'); setIsModalOpen(true); }} className="bg-white text-indigo-600 px-6 py-3 rounded-xl font-bold shadow hover:bg-indigo-50 transition flex items-center gap-2">
                             <Icons.Box size={20}/> Mulai Cek Stok
                        </button>
                    </div>
                </div>
            );
            
            const Settings = () => (
                <div className="space-y-6 animate-fade-in">
                    {/* BACKUP RESTORE SECTION */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                         <h3 className="text-lg font-bold text-slate-800 mb-4 border-b pb-2 flex items-center gap-2"><Icons.Save size={20}/> Backup & Restore (Full Database)</h3>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="space-y-2">
                                <p className="text-sm text-slate-500">Unduh seluruh data aplikasi (buku, anggota, transaksi) dalam format JSON untuk cadangan.</p>
                                <button onClick={downloadJSON} className="w-full text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100 px-4 py-3 rounded-lg flex items-center justify-center gap-2 border border-indigo-200 transition-colors">
                                    <Icons.Download size={18}/> Backup Data ke JSON
                                </button>
                            </div>
                            <div className="space-y-2">
                                <p className="text-sm text-slate-500">Pulihkan data dari file JSON cadangan. âš  Data saat ini akan ditimpa.</p>
                                <label className="w-full text-sm cursor-pointer bg-emerald-50 text-emerald-700 hover:bg-emerald-100 px-4 py-3 rounded-lg flex items-center justify-center gap-2 border border-emerald-200 transition-colors">
                                    <Icons.Upload size={18}/> Restore Data dari JSON
                                    <input type="file" className="hidden" accept=".json" onChange={handleRestoreJSON} />
                                </label>
                            </div>
                         </div>
                    </div>

                    {/* IMPORT EXPORT CSV SECTION */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                         <h3 className="text-lg font-bold text-slate-800 mb-4 border-b pb-2 flex items-center gap-2"><Icons.FileText size={20}/> Import / Export Data (Excel/CSV)</h3>
                         
                         {/* BUKU */}
                         <div className="mb-6">
                            <h4 className="font-bold text-slate-700 mb-2">Data Buku</h4>
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => downloadCSV(jsonToCSV(data.books), 'Data_Buku.csv')} className="text-sm bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded flex items-center gap-2"><Icons.Download size={16}/> Export CSV</button>
                                <button onClick={() => downloadCSV(getTemplate('books'), 'Template_Buku.csv')} className="text-sm border border-dashed border-slate-300 px-3 py-2 rounded flex items-center gap-2 text-slate-500 hover:text-slate-700"><Icons.FileText size={16}/> Download Template</button>
                                <label className="text-sm cursor-pointer bg-blue-50 text-blue-600 px-3 py-2 rounded border border-blue-100 hover:bg-blue-100 flex items-center gap-2">
                                    <Icons.Upload size={16}/> Import CSV
                                    <input type="file" className="hidden" accept=".csv" onChange={(e) => handleImportCSV(e, 'books')} />
                                </label>
                            </div>
                         </div>

                         {/* ANGGOTA */}
                         <div>
                            <h4 className="font-bold text-slate-700 mb-2">Data Anggota</h4>
                            <div className="flex flex-wrap gap-2">
                                <button onClick={() => downloadCSV(jsonToCSV(data.members), 'Data_Anggota.csv')} className="text-sm bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded flex items-center gap-2"><Icons.Download size={16}/> Export CSV</button>
                                <button onClick={() => downloadCSV(getTemplate('members'), 'Template_Anggota.csv')} className="text-sm border border-dashed border-slate-300 px-3 py-2 rounded flex items-center gap-2 text-slate-500 hover:text-slate-700"><Icons.FileText size={16}/> Download Template</button>
                                <label className="text-sm cursor-pointer bg-emerald-50 text-emerald-600 px-3 py-2 rounded border border-emerald-100 hover:bg-emerald-100 flex items-center gap-2">
                                    <Icons.Upload size={16}/> Import CSV
                                    <input type="file" className="hidden" accept=".csv" onChange={(e) => handleImportCSV(e, 'members')} />
                                </label>
                            </div>
                         </div>
                    </div>
                </div>
            );

            // --- VIEW RENDER ---
            if (printMode) return (
                <PrintView 
                    type={printMode} 
                    items={currentItem ? currentItem : (printMode === 'card' ? data.members.filter(m => selectedItems.includes(m.id)) : data.books.filter(b => selectedItems.includes(b.id)))} 
                    extraData={printData} 
                    settings={data.settings} 
                    onCancel={() => setPrintMode(null)} 
                />
            );

            return (
                <div className="flex h-screen bg-slate-50 font-sans text-slate-900 overflow-hidden">
                    <aside className="w-64 bg-slate-900 text-slate-300 hidden md:flex flex-col shadow-2xl z-20">
                        <div className="p-6 flex items-center gap-3 text-white">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-bold text-xl shadow-lg shadow-indigo-500/50">S</div>
                            <div>
                                <h1 className="font-bold text-lg leading-tight">SIMPUS</h1>
                                <p className="text-xs text-slate-400">Pro Version</p>
                            </div>
                        </div>
                        <nav className="flex-1 px-4 space-y-2 mt-4">
                            {[
                                { id: 'dashboard', icon: <Icons.LayoutGrid size={20}/>, label: 'Dashboard' },
                                { id: 'circulation', icon: <Icons.Repeat size={20}/>, label: 'Sirkulasi' },
                                { id: 'inventory', icon: <Icons.Box size={20}/>, label: 'Inventory & Stok' },
                                { id: 'books', icon: <Icons.Book size={20}/>, label: 'Data Buku' },
                                { id: 'members', icon: <Icons.Users size={20}/>, label: 'Data Anggota' },
                                { id: 'settings', icon: <Icons.Settings size={20}/>, label: 'Pengaturan' }
                            ].map(item => (
                                <button key={item.id} onClick={() => setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-200 ${activeTab === item.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-900/50 translate-x-1' : 'hover:bg-slate-800 hover:text-white'}`}>
                                    {item.icon} <span className="font-medium">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-6 text-xs text-slate-600 text-center border-t border-slate-800">
                            v2.0.2 &copy; 2024
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col h-full relative overflow-hidden">
                        <header className="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 flex justify-between items-center md:hidden z-10 sticky top-0">
                            <span className="font-bold text-indigo-900">SIMPUS Pro</span>
                            <button className="p-2 bg-slate-100 rounded-lg"><Icons.LayoutGrid/></button>
                        </header>
                        
                        <div className="flex-1 overflow-auto p-4 md:p-8 scroll-smooth">
                            {activeTab === 'dashboard' && <Dashboard />}
                            {activeTab === 'circulation' && <Circulation />}
                            {activeTab === 'inventory' && <Inventory />}
                            {activeTab === 'books' && <DataTable type="books" />}
                            {activeTab === 'members' && <DataTable type="members" />}
                            {activeTab === 'settings' && <Settings />}
                        </div>
                    </main>

                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title={
                        modalType === 'borrow' ? 'Transaksi Peminjaman' : 
                        modalType === 'inventory' ? 'Stock Opname' :
                        modalType === 'memberHistory' ? 'Riwayat Anggota' :
                        'Form Data'
                    }>
                        {renderModalContent()}
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>